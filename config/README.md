# ZoneInfo Build Configuration

Build configuration files for the ZoneInfo library, generated and managed by Alire.

## Configuration Files

### `zoneinfo_config.gpr`

**Purpose**: Generated by Alire to configure build profiles, compiler switches, and dependencies.

**Key Components**:

#### Build Profiles

```ada
type Build_Profile_Kind is ("release", "validation", "development");
Build_Profile : Build_Profile_Kind := "development";
```

**Build Profiles**:
- **`development`** - Default profile for development work
  - Optimization: `-Og` (optimize for debugging)
  - Debug symbols: `-g`
  - All checks enabled
  - Full warnings enabled
  - Best for: Active development, debugging

- **`validation`** - Profile for testing and validation
  - Used for comprehensive test suites
  - Same flags as development
  - Best for: Running test suites

- **`release`** - Production-ready optimized build
  - Optimization: `-O2` (full optimization)
  - Inlining enabled: `-gnatn`
  - Runtime checks suppressed: `-gnatp`
  - Best for: Performance benchmarking, production deployment

#### Compiler Switches

The configuration defines comprehensive Ada compiler switches in `Ada_Compiler_Switches`:

**Optimization & Debug**:
```ada
"-Og"                -- Optimize for debug (development/validation)
"-g"                 -- Generate debug symbols
"-ffunction-sections" -- Separate ELF section per function
"-fdata-sections"     -- Separate ELF section per variable
```

**Warnings**:
```ada
"-gnatwa"   -- Enable all warnings
"-gnatw.X"  -- Disable No_Exception_Propagation warnings
```

**Validity Checks**:
```ada
"-gnatVa"   -- All validity checks
```

**Style Checks** (extensive code quality enforcement):
```ada
"-gnaty3"   -- 3-space indentation
"-gnatya"   -- Check attribute casing
"-gnatyA"   -- Array index numbers in attributes
"-gnatyB"   -- Boolean operator checks
"-gnatyb"   -- No blanks at statement end
"-gnatyc"   -- Comment format checks
"-gnaty-d"  -- Disable DOS line terminator check
"-gnatye"   -- Check end/exit labels
"-gnatyf"   -- No form feeds or vertical tabs
"-gnatyh"   -- No horizontal tabs
"-gnatyi"   -- Check if-then layout
"-gnatyI"   -- Check mode IN keywords
"-gnatyk"   -- Keyword casing
"-gnatyl"   -- Layout checks
"-gnatym"   -- Maximum line length (120 chars)
"-gnatyn"   -- Casing of Standard entities
"-gnatyO"   -- Explicit overriding markers
"-gnatyp"   -- Pragma casing
"-gnatyr"   -- Identifier reference casing
"-gnatyS"   -- No statements after THEN/ELSE
"-gnatyt"   -- Token spacing
"-gnatyu"   -- No unnecessary blank lines
"-gnatyx"   -- Extra parentheses check
```

**Language & Encoding**:
```ada
"-gnat2022"  -- Ada 2022 language mode
"-gnatW8"    -- UTF-8 encoding for wide characters
```

#### Host Platform Information

Auto-detected by Alire:
```ada
Alire_Host_OS     := "macos";
Alire_Host_Arch   := "x86_64";
Alire_Host_Distro := "homebrew";
```

#### Project Metadata

```ada
Crate_Version := "0.1.0";
Crate_Name    := "zoneinfo";
```

## Build Profiles Usage

### Building with Different Profiles

#### Development Build (Default)
```bash
# Uses -Og optimization, full debug symbols, all checks enabled
alr build

# Equivalent to:
alr build -- -Xmode=debug
```

**When to use**:
- Active development
- Debugging issues
- Quick iterative builds
- Running under debugger (gdb)

#### Release Build (Optimized)
```bash
# Uses -O2 optimization, inlining, suppressed checks
alr build -- -Xmode=release

# For validation tests
alr exec -- gprbuild -P test/validation/ada/validation.gpr -Xmode=release
```

**When to use**:
- Performance benchmarking
- Production deployment
- Release artifacts
- Fair performance comparisons (see validation tests)

**Performance Impact**:
- Full-scale validation (13,156 tests):
  - Development mode: ~2.5 seconds
  - Release mode: **1.617 seconds** (35% faster)

#### Optimize Build (Maximum Performance)
```bash
# Uses -O3 optimization, maximum inlining
alr build -- -Xmode=optimize
```

**When to use**:
- Maximum performance requirements
- Embedded systems
- Real-time applications
- CPU-bound workloads

**Warning**: May increase binary size and compilation time significantly.

## Overriding Compiler Switches

### Via Environment Variable

```bash
# Add custom flags
export ADAFLAGS="-gnatec=my_config.adc -gnatec=another.adc"
alr build
```

### Via GPR External

```bash
# Override mode
alr build -- -Xmode=release -XADAFLAGS="-O3 -gnatn2"
```

## Dependencies Configuration

### TZif Library Dependency

Configured in `alire.toml`, imported via `with "tzif.gpr"` in project files:

```ada
-- In zoneinfo_config.gpr (auto-generated)
with "tzif.gpr";
```

**Dependency specification** (from `alire.toml`):
```toml
[[depends-on]]
tzif = "^1.0.0"

[[pins]]
tzif = { path = "../tzif" }
```

**TZif Cache Note**:
- TZif library includes cache infrastructure (`Source_Cache`, `Zone_Cache`)
- Uses SHA256-based content hashing for integrity
- Protected types for thread-safe access
- JSON serialization for cache export/import
- **No runtime metrics or logging currently implemented**
- Cache performance is validated through integration tests

## Configuration Best Practices

### For Development

1. **Use development profile** (default)
   - Full debug info for debugging
   - All checks catch errors early
   - Faster compilation

2. **Enable IDE integration**
   - Debug symbols help IDEs
   - Symbol tables for code navigation
   - Stack traces for crash analysis

### For Testing

1. **Use release profile for performance tests**
   - Fair comparison with other libraries
   - Realistic performance metrics
   - Example: Validation tests (see `test/validation/results/`)

2. **Use development profile for functional tests**
   - Catches constraint errors
   - Better error messages
   - Easier debugging of test failures

### For Production

1. **Always use release profile**
   ```bash
   alr build -- -Xmode=release
   ```

2. **Consider library stripping** (reduce binary size)
   ```bash
   strip libzoneinfo.so
   ```

3. **Package only necessary files**
   - Library files: `lib/`
   - Public specs: `include/`
   - License and documentation

## Troubleshooting

### Build Fails with "optimization disabled"

**Problem**: Building in development mode but expecting release performance

**Solution**:
```bash
alr build -- -Xmode=release
```

### Style Check Failures

**Problem**: Code violates GNAT style checks (line length, casing, etc.)

**Solutions**:
1. Fix the code to comply with style (preferred)
2. Temporarily disable specific checks (not recommended):
   ```bash
   # Example: disable line length check
   alr build -- -XADAFLAGS="-gnaty-m"
   ```

### Missing Debug Symbols

**Problem**: Debugger can't find source lines

**Solution**: Ensure using development or debug mode:
```bash
alr build -- -Xmode=debug
```

### Performance is Slower Than Expected

**Problem**: Using development mode in production

**Solution**: Rebuild with release mode:
```bash
alr clean
alr build -- -Xmode=release
```

**Verification**:
```bash
# Check if optimization is enabled
gnatmake -v | grep -- "-O"
# Should show -O2 for release, -Og for debug
```

## Related Documentation

- [Main Project README](../README.md)
- [Source Code Architecture](../src/README.md)
- [Validation Test Results](../test/validation/results/COMPREHENSIVE_TEST_SUMMARY.md)
- [Build and Test Guide](../docs/software_test_guide.md)
- [Alire Documentation](https://alire.ada.dev/docs/)

## External Configuration

### Alire Configuration (`alire.toml`)

See `/alire.toml` for:
- Crate metadata
- Dependencies
- Build switches
- GPR externals
- Environment variables

### Project Configuration (`zoneinfo.gpr`)

See `/zoneinfo.gpr` for:
- Build modes (debug, release, optimize)
- Source directories
- Object/library directories
- Library configuration
- Compiler switches per mode

---

**Copyright**: Â© 2025 Michael Gardner, A Bit of Help, Inc.
**License**: BSD-3-Clause
